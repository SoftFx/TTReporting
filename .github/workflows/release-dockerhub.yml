name: release-dockerhub

on:
  workflow_dispatch:
    inputs:
      variant:
        description: "Which image to build (use 'all' to build every variant)"
        type: choice
        required: true
        options:
          - all
          - big-trades
  release:
    types: [published]

permissions:
  contents: read

env:
  # Final image name on Docker Hub; change via repo Variable IMAGE_NAME if needed
  IMAGE: ${{ vars.IMAGE_NAME || format('{0}/tt-reporting', secrets.DOCKERHUB_USERNAME) }}

jobs:
  build-push:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: big-trades
            dockerfile: build/big-trades   # <-- must be an actual FILE
            context: .
            suffix: big-trades

    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Compute CalVer
        id: ver
        shell: bash
        run: |
          date_tag=$(date -u +'%Y.%m.%d')
          echo "calver=${date_tag}.${GITHUB_RUN_NUMBER}" >> "$GITHUB_OUTPUT"

      - name: Compute short SHA
        id: shortsha
        shell: bash
        run: |
          echo "short=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"         

      - name: Build & Push
        id: build
        if: ${{ github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && (inputs.variant == 'all' || matrix.name == inputs.variant)) }}
        uses: docker/build-push-action@v6
        with:
          context:   ${{ matrix.context }}
          file:      ${{ matrix.dockerfile }}
          platforms: linux/amd64
          push: true
        tags: |
          ${{ env.IMAGE }}:${{ steps.ver.outputs.calver }}-${{ matrix.suffix }}   # ← базовый CalVer
          ${{ env.IMAGE }}:latest-${{ matrix.suffix }}
          ${{ env.IMAGE }}:sha-${{ steps.shortsha.outputs.short }}-${{ matrix.suffix }}
        labels: |
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
        cache-from: type=gha
        cache-to:   type=gha,mode=max

      - name: Tag manifest by sha256 digest
        if: ${{ steps.build.outputs.digest != '' }}
        shell: bash
        run: |
          IMAGE="${{ env.IMAGE }}"
          DIGEST='${{ steps.build.outputs.digest }}'     # например: sha256:abcde123...
          D="${DIGEST#sha256:}"                          # убрать префикс
          SHORT="${D:0:12}"                              # укоротим для читабельности
          # Привяжем ещё один тег к уже опубликованному манифесту
          docker buildx imagetools create \
            -t "${IMAGE}:sha256-${SHORT}-${{ matrix.suffix }}" \
            "${IMAGE}@${DIGEST}"

      - name: Echo digest tag
        if: ${{ steps.build.outputs.digest != '' }}
        run: echo "Pushed: ${{ env.IMAGE }}:sha256-${{ steps.build.outputs.digest[8:20] }}-${{ matrix.suffix }}"

      - name: Echo published image
        if: ${{ github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && (inputs.variant == 'all' || matrix.name == inputs.variant)) }}
        shell: bash
        run: |
          echo "Pushed:"
          echo "  ${{ env.IMAGE }}:${{ steps.ver.outputs.calver }}-${{ matrix.suffix }}"
          echo "  ${{ env.IMAGE }}:latest-${{ matrix.suffix }}"
          echo "  ${{ env.IMAGE }}:sha-${{ steps.shortsha.outputs.short }}-${{ matrix.suffix }}"
          echo "  ${{ env.IMAGE }}:sha256-${{ steps.build.outputs.digest[8:20] }}-${{ matrix.suffix }}"
